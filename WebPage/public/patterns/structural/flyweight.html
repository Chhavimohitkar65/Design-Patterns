<!DOCTYPE html>
<html>
<head>
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --background: #ecf0f1;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            margin: 0;
            padding: 2rem;
            background: var(--background);
            color: var(--primary);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 2rem;
            padding: 2rem;
            background: white;
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .demo-area {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 2rem;
            margin: 2rem 0;
        }

        .forest {
            height: 500px;
            background: linear-gradient(to bottom, #87CEEB 60%, #27ae60 60%);
            border-radius: 1rem;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .controls {
            background: white;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .button {
            padding: 0.8rem 1.5rem;
            border: none;
            border-radius: 0.5rem;
            background: var(--secondary);
            color: white;
            cursor: pointer;
            transition: transform 0.1s ease;
            margin: 0.5rem;
            display: block;
            width: 100%;
        }

        .button:hover {
            transform: translateY(-2px);
        }

        .stats {
            background: white;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .tree {
            position: absolute;
            transition: transform 0.3s ease;
            cursor: help;
        }

        .tree:hover {
            transform: scale(1.1);
            z-index: 100;
        }

        .memory-chart {
            height: 200px;
            border-left: 2px solid var(--primary);
            border-bottom: 2px solid var(--primary);
            display: flex;
            align-items: flex-end;
            gap: 2px;
            padding: 1rem 0;
            margin: 1rem 0;
        }

        .memory-bar {
            flex: 1;
            background: var(--secondary);
            transition: height 0.3s ease;
        }

        .explanation {
            background: white;
            padding: 2rem;
            border-radius: 1rem;
            margin: 2rem 0;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .pattern-components {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin: 1rem 0;
        }

        .component-card {
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 0.5rem;
            border-left: 4px solid var(--secondary);
        }

        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
        }

        .comparison-table td, .comparison-table th {
            padding: 1rem;
            border: 1px solid #ddd;
            text-align: left;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Flyweight Pattern: Forest Visualization</h1>
            <p>Demonstrating memory optimization through shared object states</p>
        </div>

        <div class="demo-area">
            <div class="forest" id="forest"></div>
            <div class="controls">
                <button class="button" id="add100">Add 100 Trees</button>
                <button class="button" id="toggle">Toggle Flyweight</button>
                <button class="button" id="clear">Clear Forest</button>
                
                <div class="memory-chart" id="memoryChart">
                    <div class="memory-bar" id="flyweightMemory"></div>
                    <div class="memory-bar" id="regularMemory"></div>
                </div>

                <div class="stats">
                    <h3>Live Statistics</h3>
                    <div id="stats"></div>
                </div>
            </div>
        </div>

        <div class="explanation">
            <h2>Flyweight Pattern Explained</h2>
            
            <div class="definition">
                <h3>üìö Official Definition</h3>
                <p>The <strong>Flyweight</strong> is a structural design pattern that 
                lets you fit more objects into the available amount of RAM by sharing 
                common parts of state between multiple objects instead of keeping all 
                of the data in each object.</p>
            </div>

            <div class="key-concepts">
                <h3>üîë Key Concepts</h3>
                <div class="pattern-components">
                    <div class="component-card">
                        <h4>Intrinsic State</h4>
                        <p>Shared, immutable data stored in Flyweight objects<br>
                        <em>(e.g., tree species, color, texture)</em></p>
                    </div>
                    <div class="component-card">
                        <h4>Extrinsic State</h4>
                        <p>Unique, contextual data passed during operations<br>
                        <em>(e.g., tree position, rotation)</em></p>
                    </div>
                    <div class="component-card">
                        <h4>Flyweight Factory</h4>
                        <p>Manages pool of existing flyweights<br>
                        <em>(TreeType cache in our example)</em></p>
                    </div>
                </div>
            </div>

            <h3>üèóÔ∏è Pattern Structure</h3>
            <table class="comparison-table">
                <tr>
                    <th>Component</th>
                    <th>Our Implementation</th>
                    <th>Responsibility</th>
                </tr>
                <tr>
                    <td>Flyweight</td>
                    <td>TreeType</td>
                    <td>Stores intrinsic state (species/color/texture)</td>
                </tr>
                <tr>
                    <td>Flyweight Factory</td>
                    <td>TreeFactory</td>
                    <td>Manages shared TreeType instances</td>
                </tr>
                <tr>
                    <td>Context</td>
                    <td>Tree</td>
                    <td>Contains extrinsic state (position) + Flyweight reference</td>
                </tr>
                <tr>
                    <td>Client</td>
                    <td>Forest</td>
                    <td>Maintains tree contexts and initiates drawing</td>
                </tr>
            </table>

            <h3>‚öñÔ∏è Memory Comparison</h3>
            <table class="comparison-table">
                <tr>
                    <th></th>
                    <th>Without Flyweight</th>
                    <th>With Flyweight</th>
                </tr>
                <tr>
                    <td>Memory per tree</td>
                    <td>100 bytes (full object)</td>
                    <td>20 bytes (position only)</td>
                </tr>
                <tr>
                    <td>Memory per type</td>
                    <td>N/A (no sharing)</td>
                    <td>100 bytes (shared once)</td>
                </tr>
                <tr>
                    <td>1000 trees</td>
                    <td>100,000 bytes</td>
                    <td>(1000√ó20) + (3√ó100) = 20,300 bytes</td>
                </tr>
            </table>
        </div>
    </div>

    <script>
        class TreeType {
            constructor(species, color, texture) {
                this.species = species;
                this.color = color;
                this.texture = texture;
                this._memory = 100; // Intrinsic state memory
            }

            draw(x, y) {
                const tree = document.createElement('div');
                tree.className = 'tree';
                tree.style.left = `${x}px`;
                tree.style.bottom = `${y}px`;
                tree.title = `Species: ${this.species}\nColor: ${this.color}\nTexture: ${this.texture}`;
                
                tree.innerHTML = `
                    <svg width="50" height="80" viewBox="0 0 50 80">
                        <path d="M25 0 L40 30 L10 30 Z" fill="${this.color}"/>
                        <rect x="20" y="30" width="10" height="20" fill="#8B4513"/>
                    </svg>
                `;
                
                return tree;
            }
        }

        class TreeFactory {
            constructor() {
                this.types = new Map();
            }

            getType(species, color, texture) {
                const key = `${species}-${color}-${texture}`;
                if (!this.types.has(key)) {
                    this.types.set(key, new TreeType(species, color, texture));
                }
                return this.types.get(key);
            }

            get typeCount() {
                return this.types.size;
            }
        }

        class Forest {
            constructor() {
                this.trees = [];
                this.factory = new TreeFactory();
                this.useFlyweight = true;
                this.container = document.getElementById('forest');
            }

            addTree(species, color, texture, x, y) {
                const type = this.useFlyweight 
                    ? this.factory.getType(species, color, texture)
                    : new TreeType(species, color, texture);

                const tree = {
                    type: type,
                    x: x,
                    y: y,
                    element: type.draw(x, y)
                };

                this.trees.push(tree);
                this.container.appendChild(tree.element);
                this.updateDisplay();
            }

            clear() {
                this.trees.forEach(tree => tree.element.remove());
                this.trees = [];
                this.factory.types.clear();
                this.updateDisplay();
            }

            get memoryUsage() {
                if (this.useFlyweight) {
                    return (this.trees.length * 20) + // Extrinsic state
                           (this.factory.typeCount * 100); // Intrinsic state
                }
                return this.trees.length * 100; // All data stored per object
            }

            updateDisplay() {
                const statsElement = document.getElementById('stats');
                if (statsElement) {
                    statsElement.innerHTML = `
                        Total Trees: ${this.trees.length}<br>
                        Tree Types: ${this.useFlyweight ? this.factory.typeCount : this.trees.length}<br>
                        Estimated Memory: ${Math.round(this.memoryUsage / 1024)} KB
                    `;
                }

                // Update memory chart
                const regularMemory = this.trees.length * 100;
                const maxMemory = Math.max(regularMemory, this.memoryUsage, 1);
                
                document.getElementById('flyweightMemory').style.height = 
                    `${(this.memoryUsage / maxMemory) * 100}%`;
                document.getElementById('regularMemory').style.height = 
                    `${(regularMemory / maxMemory) * 100}%`;
            }
        }

        // Initialize forest
        const forest = new Forest();
        const speciesOptions = [
            ['Pine', '#2ecc71'],
            ['Oak', '#27ae60'],
            ['Maple', '#16a085']
        ];

        // Add trees with random positions
        function addRandomTrees(count) {
            for (let i = 0; i < count; i++) {
                const [species, color] = speciesOptions[Math.floor(Math.random() * speciesOptions.length)];
                const x = Math.random() * (forest.container.offsetWidth - 50);
                const y = Math.random() * (forest.container.offsetHeight - 80);
                forest.addTree(species, color, 'default', x, y);
            }
        }

        // Event listeners
        document.getElementById('add100').addEventListener('click', () => addRandomTrees(100));
        document.getElementById('clear').addEventListener('click', () => forest.clear());
        document.getElementById('toggle').addEventListener('click', () => {
            forest.useFlyweight = !forest.useFlyweight;
            forest.clear();
            document.getElementById('toggle').textContent = 
                forest.useFlyweight ? 'Disable Flyweight' : 'Enable Flyweight';
        });

        // Initial load
        addRandomTrees(50);
    </script>
</body>
</html>